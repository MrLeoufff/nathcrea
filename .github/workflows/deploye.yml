name: Deploy Nathcrea to Raspberry Pi

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      SSHPASS: ${{ secrets.SSHPASS }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install sshpass & update apt
        run: |
          sudo apt update
          sudo apt install -y sshpass

      - name: Deploy application
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_IP }} << 'EOF'
          if [ ! -d /var/www/nathcrea ]; then
            echo "Directory does not exist. Cloning repository...";
            git clone https://github.com/MrLeoufff/nathcrea.git /var/www/nathcrea;
          else
            echo "Directory exists. Pulling latest changes...";
            cd /var/www/nathcrea &&
            git config --global --add safe.directory /var/www/nathcrea &&
            git pull origin main;
          fi;

          echo "Checking dependencies...";
          cd /var/www/nathcrea &&
          if [ ! -d vendor ]; then
            echo "Installing dependencies...";
            composer install --no-interaction --prefer-dist --optimize-autoloader;
          else
            echo "Dependencies already installed.";
          fi;

          echo "Clearing cache...";
          php bin/console cache:clear --env=prod;

          echo "Restarting services...";
          sudo systemctl restart nginx;
          EOF
